<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SAISys RouteXplorer</title>

  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>

  <!-- LOADING SCREEN -->
  <div id="loading-screen">
    <div class="loader-content">
      <h1 class="loader-title">GROUP 3 NETWORKING</h1>
      <div class="loader-spinner"></div>
      <p class="loader-text">Loading, please wait...</p>
    </div>
  </div>

  <!-- NAVIGATION BAR -->
  <nav class="navbar">
    <div class="nav-left">
      <h1>SAISys RouteXplorer</h1>
      <p>Your path, redefined.</p>
    </div>

    <div class="theme-toggle">
      <input type="checkbox" id="mode-toggle">
      <label for="mode-toggle" class="toggle-label">
        <div class="toggle-inner">
          <span class="icon sun">‚òÄÔ∏è</span>
          <span class="icon moon">üåô</span>
        </div>
        <div class="toggle-ball"></div>
      </label>
    </div>
  </nav>

  <!-- MAIN PANEL -->
  <div class="panel">
    <label>Origin</label>
    <input id="origin" type="text" placeholder="e.g., Batangas City Hall" />

    <label>Destination</label>
    <input id="destination" type="text" placeholder="e.g., SM City Batangas" />

    <div class="row">
      <div>
        <label>Vehicle</label>
        <select id="vehicle">
          <option value="car">Car</option>
          <option value="motorcycle">Motorcycle</option>
          <option value="bike">Bike</option>
          <option value="foot">Walking</option>
          <option value="ebike">E-Bike</option>
        </select>
      </div>
    </div>

    <button id="generate" class="btn">Generate Report</button>
    <p id="status" class="status">Ready</p>
  </div>

  <!-- MAP + KPI RESULTS -->
  <div class="map-container">
    <div id="map"></div>

    <!-- KPI CARDS -->
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-icon kpi-blue">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 6h5l2 6 3-4h8" />
            <circle cx="6" cy="6" r="2" fill="currentColor"></circle>
            <circle cx="21" cy="8" r="2" fill="currentColor"></circle>
          </svg>
        </div>
        <div class="kpi-body">
          <div class="kpi-label">Distance</div>
          <div class="kpi-value" id="kpi-distance">‚Äî</div>
          <div class="kpi-sub" id="kpi-distance-sub">‚Äî</div>
        </div>
      </div>

      <div class="kpi-card">
        <div class="kpi-icon kpi-purple">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="9"></circle>
            <path d="M12 7v6l4 2"></path>
          </svg>
        </div>
        <div class="kpi-body">
          <div class="kpi-label">Duration</div>
          <div class="kpi-value" id="kpi-duration">‚Äî</div>
          <div class="kpi-sub" id="kpi-duration-sub">‚Äî</div>
        </div>
      </div>

      <!-- KPI 3 (dynamic: Fuel / Steps / Calories) -->
      <div class="kpi-card">
        <div class="kpi-icon kpi-green">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 7a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v12H3z"></path>
            <path d="M16 7l3 3v5a3 3 0 0 1-3 3h-1"></path>
            <circle cx="7" cy="11" r="1.5" fill="currentColor"></circle>
          </svg>
        </div>
        <div class="kpi-body">
          <div class="kpi-label" id="kpi-a-label">Fuel</div>
          <div class="kpi-value" id="kpi-a">‚Äî</div>
          <div class="kpi-sub" id="kpi-a-sub">eff 7.0 L/100km</div>
        </div>
      </div>

      <!-- KPI 4 (dynamic: Cost / Calories / Avg Speed) -->
      <div class="kpi-card">
        <div class="kpi-icon kpi-orange">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M7 20V4h6a5 5 0 0 1 0 10H7"></path>
            <path d="M7 10h10M7 14h10"></path>
          </svg>
        </div>
        <div class="kpi-body">
          <div class="kpi-label" id="kpi-b-label">Cost</div>
          <div class="kpi-value" id="kpi-b">‚Äî</div>
          <div class="kpi-sub" id="kpi-b-sub">‚Ç±57.20/L</div>
        </div>
      </div>
    </div>

    <!-- INSTRUCTIONS -->
    <div class="instructions" id="instructions">
      <h2>Turn-by-Turn Instructions</h2>
      <table>
        <thead>
          <tr><th>Instruction</th><th>Distance</th></tr>
        </thead>
        <tbody id="instruction-list">
          <tr><td colspan="2">No data yet.</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // ---------- CONFIGURABLE ASSUMPTIONS ----------
    const DEFAULT_KEY = "05ddb74c-90fe-4dad-9236-e37bb1fc2003";
    const USER_WEIGHT_KG = 70;       // assumed user weight for calorie estimates
    const STEPS_PER_KM = 1250;       // average steps per km
    const MET_WALK = 3.3;            // walking ~3 mph
    const MET_BIKE = 7.5;            // moderate cycling
    // Fuel assumptions for motor vehicles:
    const DEFAULT_EFF_L_PER_100KM = 7.0; // car fuel efficiency
    const FUEL_PRICE = 57.20;            // ‚Ç±/L

    // ---------- UI BOOT ----------
    window.addEventListener("load", () => {
      const loader = document.getElementById("loading-screen");
      setTimeout(() => {
        loader.classList.add("fade-out");
        setTimeout(() => loader.style.display = "none", 800);
      }, 1500);
    });

    const modeToggle = document.getElementById("mode-toggle");
    modeToggle.addEventListener("change", () =>
      document.body.classList.toggle("light-mode", modeToggle.checked)
    );

    // ---------- MAP ----------
    const $ = id => document.getElementById(id);
    const map = L.map('map', {center:[13.759,121.058], zoom:12});
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19}).addTo(map);

    let routeLine = null;
    function drawRoute(coords){
      if(routeLine) map.removeLayer(routeLine);
      routeLine = L.polyline(coords, {color:'#00ff90', weight:5}).addTo(map);
      map.fitBounds(routeLine.getBounds());
    }

    // ---------- HELPERS ----------
    async function geocode(q){
      const u = new URL('https://graphhopper.com/api/1/geocode');
      u.searchParams.set('q', q);
      u.searchParams.set('limit', 1);
      u.searchParams.set('key', DEFAULT_KEY);
      const r = await fetch(u);
      const j = await r.json();
      if(!j.hits.length) throw new Error('No result for ' + q);
      return j.hits[0].point; // {lat, lng}
    }

    function prettyTime(ms){
      const s = Math.round(ms/1000);
      const h = Math.floor(s/3600);
      const m = Math.floor((s%3600)/60);
      const sec = s%60;
      return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
    }
    function kmToMiles(km){ return km / 1.60934; }
    const fmtPeso = n => `‚Ç±${n.toFixed(2)}`;
    const fmt1 = n => n.toFixed(1);
    const fmt2 = n => n.toFixed(2);

    // Calories using MET formula: kcal = MET * 3.5 * weight(kg) / 200 * minutes
    function estimateCalories(MET, minutes, weightKg = USER_WEIGHT_KG){
      return MET * 3.5 * weightKg / 200 * minutes;
    }

    // ---------- KPI SETTER ----------
    function setKPI(labelsAndValues){
      const { aLabel, aValue, aSub, bLabel, bValue, bSub } = labelsAndValues;
      $('kpi-a-label').textContent = aLabel;
      $('kpi-a').textContent = aValue;
      $('kpi-a-sub').textContent = aSub;

      $('kpi-b-label').textContent = bLabel;
      $('kpi-b').textContent = bValue;
      $('kpi-b-sub').textContent = bSub;
    }

    // ---------- MAIN ----------
    $('generate').addEventListener('click', async ()=>{
      try{
        $('status').innerText = 'Working...';
        $('instruction-list').innerHTML = '<tr><td colspan="2">Loading...</td></tr>';

        const from = $('origin').value.trim();
        const to = $('destination').value.trim();
        const vehicle = $('vehicle').value;

        if(!from || !to){
          $('status').innerText = 'Please enter both Origin and Destination.';
          return;
        }

        const g1 = await geocode(from);
        const g2 = await geocode(to);

        const params = new URLSearchParams({
          point: `${g1.lat},${g1.lng}`,
          vehicle,
          points_encoded: 'false',
          instructions: 'true',
          key: DEFAULT_KEY
        });
        params.append('point', `${g2.lat},${g2.lng}`);

        const res = await fetch('https://graphhopper.com/api/1/route?' + params);
        const data = await res.json();
        if(!data.paths || !data.paths.length) throw new Error(data.message || 'No route found');

        const path = data.paths[0];
        const coords = path.points.coordinates.map(c=>[c[1],c[0]]);
        drawRoute(coords);

        const km = path.distance / 1000;
        const miles = kmToMiles(km);
        const durMs = path.time;
        const mins = Math.round(durMs/60000);
        const hours = durMs / 3600000;
        const avgSpeedKmh = hours > 0 ? km / hours : 0;

        // Always set distance & duration
        $('kpi-distance').textContent = `${fmt1(km)} km`;
        $('kpi-distance-sub').textContent = `${fmt1(miles)} mi`;

        $('kpi-duration').textContent = prettyTime(durMs);
        $('kpi-duration-sub').textContent = `${mins} min`;

        // Switch KPI 3 & 4 based on vehicle
        if (vehicle === 'foot') {
          // Walking ‚Üí Steps & Calories
          const steps = Math.round(km * STEPS_PER_KM);
          const kcal = estimateCalories(MET_WALK, mins);

          setKPI({
            aLabel: 'Steps',
            aValue: steps.toLocaleString(),
            aSub: `~${STEPS_PER_KM} steps/km`,
            bLabel: 'Calories',
            bValue: `${fmt0(kcal)} kcal`,
            bSub: `MET ${MET_WALK}, ${USER_WEIGHT_KG} kg`
          });
        } else if (vehicle === 'bike') {
          // Biking ‚Üí Calories & Avg Speed
          const kcal = estimateCalories(MET_BIKE, mins);

          setKPI({
            aLabel: 'Calories',
            aValue: `${fmt0(kcal)} kcal`,
            aSub: `MET ${MET_BIKE}, ${USER_WEIGHT_KG} kg`,
            bLabel: 'Avg Speed',
            bValue: `${fmt1(avgSpeedKmh)} km/h`,
            bSub: `${fmt1(km)} km in ${mins} min`
          });
        } else {
          // Motorized (car/motorcycle/ebike) ‚Üí Fuel & Cost
          const eff = DEFAULT_EFF_L_PER_100KM;
          const fuelL = (km * eff) / 100;
          const fuelCost = fuelL * FUEL_PRICE;

          setKPI({
            aLabel: 'Fuel',
            aValue: `${fmt2(fuelL)} L`,
            aSub: `eff ${eff.toFixed(1)} L/100km`,
            bLabel: 'Cost',
            bValue: fmtPeso(fuelCost),
            bSub: `@ ${fmtPeso(FUEL_PRICE)}/L`
          });
        }

        // Instructions table
        const list = path.instructions.map(inst => `
          <tr><td>${inst.text}</td><td>${(inst.distance/1000).toFixed(2)} km</td></tr>
        `).join('');
        $('instruction-list').innerHTML = list;
        $('status').innerText = 'Route generated successfully!';
      }catch(e){
        $('status').innerText = 'Error: ' + e.message;
        console.error(e);
      }
    });

    // tiny helpers used above
    function fmt0(n){ return Math.round(n).toString(); }
  </script>
</body>
</html>
