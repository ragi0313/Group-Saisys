<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SAISys RouteXplorer</title>

  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    /* Minimal helpers for new UI */
    .marker-emoji{ font-size:20px; line-height:20px; }
    .kpi-grid{ display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:12px; }
    @media (max-width:900px){ .kpi-grid{ grid-template-columns:repeat(2,1fr); } }
    .legend{ font-size:13px; opacity:.85; margin:6px 0 10px; display:flex; align-items:center; gap:10px; }
    .swatch{ width:16px; height:4px; border-radius:2px; display:inline-block; vertical-align:middle; }
    .swatch-route{ background:#00ff90; }

    /* Instructions icons & highlight */
    .inst-icon{ width:24px; text-align:center; }
    .inst-row-dest{ background: rgba(0,255,144,0.12); font-weight:600; }
    .inst-row-dest td{ border-top:2px solid #00ff90; border-bottom:2px solid #00ff90; }

    /* ---------- Autocomplete styles ---------- */
    .input-wrap{ position:relative; }
    .ac-box{
      position:absolute; left:0; right:0; top:100%; z-index:50;
      background:#0b1220; color:#e8eefc; border:1px solid rgba(255,255,255,.1);
      border-radius:10px; margin-top:6px; max-height:260px; overflow:auto;
      box-shadow:0 10px 24px rgba(0,0,0,.35);
    }
    body.light-mode .ac-box{ background:#fff; color:#111; border-color:rgba(0,0,0,.12); }
    .ac-item{
      padding:10px 12px; cursor:pointer; display:grid; grid-template-columns: 1fr auto; gap:10px;
    }
    .ac-item:hover, .ac-item.active{ background:rgba(0,255,144,.12); }
    .ac-title{ font-size:14px; line-height:1.2; }
    .ac-sub{ font-size:12px; opacity:.75; }
    .ac-badge{ font-size:12px; opacity:.7; white-space:nowrap; }
    .ac-empty{ padding:10px 12px; font-size:13px; opacity:.7; }
  </style>
</head>
<body>

  <!-- LOADING SCREEN -->
  <div id="loading-screen">
    <div class="loader-content">
      <h1 class="loader-title">GROUP 3 NETWORKING</h1>
      <div class="loader-spinner"></div>
      <p class="loader-text">Loading, please wait...</p>
    </div>
  </div>

  <!-- NAVIGATION BAR -->
  <nav class="navbar">
    <div class="nav-left">
      <h1>SAISys RouteXplorer</h1>
      <p>Your path, redefined.</p>
    </div>

    <div class="theme-toggle">
      <input type="checkbox" id="mode-toggle">
      <label for="mode-toggle" class="toggle-label">
        <div class="toggle-inner">
          <span class="icon sun">‚òÄÔ∏è</span>
          <span class="icon moon">üåô</span>
        </div>
        <div class="toggle-ball"></div>
      </label>
    </div>
  </nav>

  <!-- MAIN PANEL -->
  <div class="panel">
    <label>Origin</label>
    <div class="input-wrap">
      <input id="origin" type="text" placeholder="e.g., Batangas City Hall" autocomplete="off" />
      <div class="ac-box" id="ac-origin" hidden></div>
    </div>

    <label>Destination</label>
    <div class="input-wrap">
      <input id="destination" type="text" placeholder="e.g., SM City Batangas" autocomplete="off" />
      <div class="ac-box" id="ac-destination" hidden></div>
    </div>

    <div class="row">
      <div>
        <label>Vehicle</label>
        <select id="vehicle">
          <option value="car">Car</option>
          <option value="motorcycle">Motorcycle</option>
          <option value="bike">Bike</option>
          <option value="foot">Walking</option>
          <option value="ebike">E-Bike</option>
        </select>
      </div>
    </div>

    <button id="generate" class="btn">Generate Report</button>
    <p id="status" class="status">Ready</p>
  </div>

  <!-- MAP + KPI RESULTS -->
  <div class="map-container">
    <div id="map" style="height:420px;"></div>
    <div class="legend"><span class="swatch swatch-route"></span> Suggested route</div>

    <!-- KPI CARDS -->
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-icon kpi-blue">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 6h5l2 6 3-4h8" />
            <circle cx="6" cy="6" r="2" fill="currentColor"></circle>
            <circle cx="21" cy="8" r="2" fill="currentColor"></circle>
          </svg>
        </div>
        <div class="kpi-body">
          <div class="kpi-label">Distance</div>
          <div class="kpi-value" id="kpi-distance">‚Äî</div>
          <div class="kpi-sub" id="kpi-distance-sub">‚Äî</div>
        </div>
      </div>

      <div class="kpi-card">
        <div class="kpi-icon kpi-purple">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="9"></circle>
            <path d="M12 7v6l4 2"></path>
          </svg>
        </div>
        <div class="kpi-body">
          <div class="kpi-label">Duration</div>
          <div class="kpi-value" id="kpi-duration">‚Äî</div>
          <div class="kpi-sub" id="kpi-duration-sub">‚Äî</div>
        </div>
      </div>

      <!-- KPI 3 (dynamic: Fuel / Steps / Calories / Energy) -->
      <div class="kpi-card">
        <div class="kpi-icon kpi-green">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 7a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v12H3z"></path>
            <path d="M16 7l3 3v5a3 3 0 0 1-3 3h-1"></path>
            <circle cx="7" cy="11" r="1.5" fill="currentColor"></circle>
          </svg>
        </div>
        <div class="kpi-body">
          <div class="kpi-label" id="kpi-a-label">Fuel</div>
          <div class="kpi-value" id="kpi-a">‚Äî</div>
          <div class="kpi-sub" id="kpi-a-sub">eff 7.0 L/100km</div>
        </div>
      </div>

      <!-- KPI 4 (dynamic: Cost / Calories / Avg Speed / Charge Cost) -->
      <div class="kpi-card">
        <div class="kpi-icon kpi-orange">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M7 20V4h6a5 5 0 0 1 0 10H7"></path>
            <path d="M7 10h10M7 14h10"></path>
          </svg>
        </div>
        <div class="kpi-body">
          <div class="kpi-label" id="kpi-b-label">Cost</div>
          <div class="kpi-value" id="kpi-b">‚Äî</div>
          <div class="kpi-sub" id="kpi-b-sub">‚Ç±57.20/L</div>
        </div>
      </div>
    </div>

    <!-- INSTRUCTIONS -->
    <div class="instructions" id="instructions">
      <h2 id="inst-title">Turn-by-Turn Instructions</h2>
      <table>
        <thead>
          <tr><th class="inst-icon">‚Ü™</th><th>Instruction</th><th>Distance</th></tr>
        </thead>
        <tbody id="instruction-list">
          <tr><td colspan="3">No data yet.</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // ---------- CONFIGURABLE ASSUMPTIONS ----------
    const DEFAULT_KEY = "05ddb74c-90fe-4dad-9236-e37bb1fc2003";

    // User/fitness assumptions
    const USER_WEIGHT_KG = 70;        // for calorie estimates
    const STEPS_PER_KM = 1250;        // avg steps per km
    const MET_WALK = 3.3;             // walking ~3 mph
    const MET_BIKE = 7.5;             // moderate cycling

    // Fuel & power assumptions
    const CAR_EFF_L_PER_100KM = 7.0;      // car efficiency
    const MOTO_EFF_L_PER_100KM = 3.0;     // motorcycle efficiency
    const FUEL_PRICE = 57.20;             // ‚Ç±/L (gasoline)
    const EBIKE_WH_PER_KM = 12;           // typical e-bike consumption ~12 Wh/km
    const ELEC_RATE_PHP_PER_KWH = 12.0;   // ‚Ç± per kWh

    // GraphHopper vehicle profile mapping
    const VEHICLE_PROFILE = {
      car: 'car',
      motorcycle: 'car',   // fallback (GraphHopper may not have motorcycle profile)
      bike: 'bike',
      foot: 'foot',
      ebike: 'bike'        // route like bike, but KPIs are electric
    };

    // ---------- UI BOOT ----------
    window.addEventListener("load", () => {
      const loader = document.getElementById("loading-screen");
      setTimeout(() => {
        loader.classList.add("fade-out");
        setTimeout(() => loader.style.display = "none", 800);
      }, 1200);
    });

    const modeToggle = document.getElementById("mode-toggle");
    modeToggle.addEventListener("change", () =>
      document.body.classList.toggle("light-mode", modeToggle.checked)
    );

    const $ = id => document.getElementById(id);

    // ---------- MAP ----------
    const map = L.map('map', {center:[13.759,121.058], zoom:12});
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19}).addTo(map);

    // Origin/Destination markers
    const startIcon = L.divIcon({className:'marker-emoji', html:'üìç', iconSize:[20,20], iconAnchor:[10,10]});
    const greenFlagSVG = `
      <svg width="22" height="22" viewBox="0 0 24 24">
        <path d="M6 3v18" fill="none" stroke="#1f2937" stroke-width="2"/>
        <path d="M7 4h9l-2 3 2 3H7z" fill="#00ff90" stroke="#00ff90" stroke-width="1"/>
      </svg>`;
    const endIcon = L.divIcon({className:'marker-emoji', html: greenFlagSVG, iconSize:[22,22], iconAnchor:[10,18]});
    let startMarker = null, endMarker = null;

    // Route polyline
    let routeLine = null;

    function drawRoute(coords){
      if(routeLine) map.removeLayer(routeLine);
      routeLine = L.polyline(coords, {color:'#00ff90', weight:6}).addTo(map);
      map.fitBounds(routeLine.getBounds(), {padding:[20,20]});
    }

    // ---------- HELPERS ----------
    async function geocode(q){
      const u = new URL('https://graphhopper.com/api/1/geocode');
      u.searchParams.set('q', q);
      u.searchParams.set('limit', 1);
      u.searchParams.set('key', DEFAULT_KEY);
      const r = await fetch(u);
      const j = await r.json();
      if(!j.hits.length) throw new Error('No result for ' + q);
      return j.hits[0].point; // {lat, lng}
    }

    async function geocodeSuggest(q, limit=6, controller){
      const u = new URL('https://graphhopper.com/api/1/geocode');
      u.searchParams.set('q', q);
      u.searchParams.set('limit', limit);
      u.searchParams.set('key', DEFAULT_KEY);
      const r = await fetch(u, { signal: controller?.signal });
      if(!r.ok) return { hits: [] };
      return r.json();
    }

    function prettyTime(ms){
      const s = Math.round(ms/1000);
      const h = Math.floor(s/3600);
      const m = Math.floor((s%3600)/60);
      const sec = s%60;
      return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
    }
    function kmToMiles(km){ return km / 1.60934; }
    const fmtPeso = n => `‚Ç±${n.toFixed(2)}`;
    const fmt1 = n => n.toFixed(1);
    const fmt2 = n => n.toFixed(2);
    function fmt0(n){ return Math.round(n).toString(); }

    // Calories using MET formula: kcal = MET * 3.5 * weight(kg) / 200 * minutes
    function estimateCalories(MET, minutes, weightKg = USER_WEIGHT_KG){
      return MET * 3.5 * weightKg / 200 * minutes;
    }

    // Map GraphHopper "sign" to an icon
    function iconForInstruction(sign, text){
      // Fallback by keywords if sign is undefined
      const t = (text || '').toLowerCase();
      const has = k => t.includes(k);
      if (sign === 4 || has('destination') || has('arrive')) return 'üèÅ';
      if (sign === 9 || has('roundabout')) return '‚ü≥';
      if (sign === 3 || has('sharp right')) return '‚Ü±';
      if (sign === 2 || has('right')) return '‚û°Ô∏è';
      if (sign === 1 || has('slight right')) return '‚ÜóÔ∏è';
      if (sign === 5 || has('sharp left')) return '‚Ü∞';
      if (sign === 6 || has('left')) return '‚¨ÖÔ∏è';
      if (sign === 7 || has('slight left')) return '‚ÜñÔ∏è';
      if (has('u-turn') || has('uturn')) return '‚Ü©Ô∏è';
      if (has('continue') || has('straight')) return '‚¨ÜÔ∏è';
      return '‚Ä¢';
    }

    function setKPI({km, durMs, vehicle}){
      const miles = kmToMiles(km);
      const mins = Math.round(durMs/60000);
      const hours = durMs / 3600000;
      const avgSpeedKmh = hours > 0 ? km / hours : 0;

      $('kpi-distance').textContent = `${fmt1(km)} km`;
      $('kpi-distance-sub').textContent = `${fmt1(miles)} mi`;

      $('kpi-duration').textContent = prettyTime(durMs);
      $('kpi-duration-sub').textContent = `${mins} min`;

      if (vehicle === 'foot') {
        const steps = Math.round(km * STEPS_PER_KM);
        const kcal = estimateCalories(MET_WALK, mins);
        $('kpi-a-label').textContent = 'Steps';
        $('kpi-a').textContent = steps.toLocaleString();
        $('kpi-a-sub').textContent = `~${STEPS_PER_KM} steps/km`;

        $('kpi-b-label').textContent = 'Calories';
        $('kpi-b').textContent = `${fmt0(kcal)} kcal`;
        $('kpi-b-sub').textContent = `MET ${MET_WALK}, ${USER_WEIGHT_KG} kg`;
      }
      else if (vehicle === 'bike') {
        const kcal = estimateCalories(MET_BIKE, mins);
        $('kpi-a-label').textContent = 'Calories';
        $('kpi-a').textContent = `${fmt0(kcal)} kcal`;
        $('kpi-a-sub').textContent = `MET ${MET_BIKE}, ${USER_WEIGHT_KG} kg`;

        $('kpi-b-label').textContent = 'Avg Speed';
        $('kpi-b').textContent = `${fmt1(avgSpeedKmh)} km/h`;
        $('kpi-b-sub').textContent = `${fmt1(km)} km in ${mins} min`;
      }
      else if (vehicle === 'ebike') {
        const wh = km * EBIKE_WH_PER_KM;
        const kwh = wh / 1000;
        const chargeCost = kwh * ELEC_RATE_PHP_PER_KWH;
        $('kpi-a-label').textContent = 'Energy';
        $('kpi-a').textContent = `${fmt2(wh)} Wh`;
        $('kpi-a-sub').textContent = `${EBIKE_WH_PER_KM} Wh/km`;

        $('kpi-b-label').textContent = 'Charge Cost';
        $('kpi-b').textContent = fmtPeso(chargeCost);
        $('kpi-b-sub').textContent = `@ ‚Ç±${ELEC_RATE_PHP_PER_KWH.toFixed(2)}/kWh`;
      }
      else if (vehicle === 'motorcycle') {
        const fuelL = (km * MOTO_EFF_L_PER_100KM) / 100;
        const fuelCost = fuelL * FUEL_PRICE;
        $('kpi-a-label').textContent = 'Fuel';
        $('kpi-a').textContent = `${fmt2(fuelL)} L`;
        $('kpi-a-sub').textContent = `eff ${MOTO_EFF_L_PER_100KM.toFixed(1)} L/100km`;

        $('kpi-b-label').textContent = 'Cost';
        $('kpi-b').textContent = fmtPeso(fuelCost);
        $('kpi-b-sub').textContent = `@ ${fmtPeso(FUEL_PRICE)}/L`;
      }
      else {
        const fuelL = (km * CAR_EFF_L_PER_100KM) / 100;
        const fuelCost = fuelL * FUEL_PRICE;
        $('kpi-a-label').textContent = 'Fuel';
        $('kpi-a').textContent = `${fmt2(fuelL)} L`;
        $('kpi-a-sub').textContent = `eff ${CAR_EFF_L_PER_100KM.toFixed(1)} L/100km`;

        $('kpi-b-label').textContent = 'Cost';
        $('kpi-b').textContent = fmtPeso(fuelCost);
        $('kpi-b-sub').textContent = `@ ${fmtPeso(FUEL_PRICE)}/L`;
      }
    }

    function renderInstructions(path){
      const rows = path.instructions.map(inst => {
        const icon = iconForInstruction(inst.sign, inst.text);
        const isDest = /destination|arrive|finish/i.test(inst.text || '');
        const distKm = (inst.distance/1000).toFixed(2);
        return `
          <tr class="${isDest ? 'inst-row-dest' : ''}">
            <td class="inst-icon">${icon}</td>
            <td>${inst.text}</td>
            <td>${distKm} km</td>
          </tr>
        `;
      }).join('');
      $('instruction-list').innerHTML = rows || '<tr><td colspan="3">No steps.</td></tr>';
      $('inst-title').textContent = 'Turn-by-Turn Instructions';
    }

    // ---------- AUTOCOMPLETE ----------
    function setupAutocomplete(inputId, boxId){
      const input = $(inputId);
      const box   = $(boxId);
      let items = [];
      let active = -1;
      let lastQuery = '';
      let aborter = null;
      let hideTimer = null;

      function hide(){ box.hidden = true; box.innerHTML=''; active=-1; }
      function show(){ box.hidden = false; }
      function setActive(idx){
        const nodes = [...box.querySelectorAll('.ac-item')];
        nodes.forEach((n,i)=> n.classList.toggle('active', i===idx));
        active = idx;
      }

      function render(results){
        items = results.hits || [];
        if(!items.length){ box.innerHTML = `<div class="ac-empty">No matches</div>`; show(); return; }
        box.innerHTML = items.map((h,i)=>{
          const title = h.name || (h.street || '') + (h.housenumber ? ' ' + h.housenumber : '');
          const sub   = [h.city, h.state, h.country].filter(Boolean).join(' ‚Ä¢ ');
          const badge = h.osm_key || h.osm_value || h.point?.type || 'place';
          return `
            <div class="ac-item" data-idx="${i}">
              <div>
                <div class="ac-title">${title || 'Unnamed'}</div>
                <div class="ac-sub">${sub}</div>
              </div>
              <div class="ac-badge">${badge}</div>
            </div>`;
        }).join('');
        show();
      }

      function pick(i){
        const h = items[i];
        if(!h) return;
        const title = h.name || [h.street, h.housenumber, h.city, h.state, h.country].filter(Boolean).join(', ');
        input.value = title || '';
        hide();
      }

      // Debounce input
      let t=null;
      input.addEventListener('input', ()=>{
        const q = input.value.trim();
        if(q===lastQuery){ return; }
        lastQuery = q;
        if(t) clearTimeout(t);
        if(q.length < 2){ hide(); return; }
        t = setTimeout(async ()=>{
          try{
            if(aborter) aborter.abort();
            aborter = new AbortController();
            const results = await geocodeSuggest(q, 6, aborter);
            render(results);
          }catch(e){ /* ignore aborts */ }
        }, 250);
      });

      // Keyboard navigation
      input.addEventListener('keydown', (ev)=>{
        const visible = !box.hidden && items.length;
        if(!visible) return;
        if(ev.key === 'ArrowDown'){ ev.preventDefault(); setActive(Math.min(active+1, items.length-1)); }
        else if(ev.key === 'ArrowUp'){ ev.preventDefault(); setActive(Math.max(active-1, 0)); }
        else if(ev.key === 'Enter'){
          if(active >= 0){ ev.preventDefault(); pick(active); }
          hide();
        } else if(ev.key === 'Escape'){ hide(); }
      });

      // Mouse interactions
      box.addEventListener('mousedown', (e)=>{
        const el = e.target.closest('.ac-item');
        if(!el) return;
        const idx = Number(el.dataset.idx);
        pick(idx);
      });

      // Hide on blur (with small delay to allow click)
      input.addEventListener('blur', ()=>{
        hideTimer = setTimeout(hide, 150);
      });
      input.addEventListener('focus', ()=>{
        if(hideTimer){ clearTimeout(hideTimer); hideTimer=null; }
        if(items.length){ show(); }
      });
    }

    setupAutocomplete('origin','ac-origin');
    setupAutocomplete('destination','ac-destination');

    // ---------- MAIN ----------
    $('generate').addEventListener('click', async ()=>{
      try{
        $('status').innerText = 'Working...';
        $('instruction-list').innerHTML = '<tr><td colspan="3">Loading...</td></tr>';

        const from = $('origin').value.trim();
        const to = $('destination').value.trim();
        const vehicle = $('vehicle').value;

        if(!from || !to){
          $('status').innerText = 'Please enter both Origin and Destination.';
          return;
        }

        const g1 = await geocode(from);
        const g2 = await geocode(to);

        // Update markers
        if(startMarker) map.removeLayer(startMarker);
        if(endMarker) map.removeLayer(endMarker);
        startMarker = L.marker([g1.lat, g1.lng], {icon:startIcon}).addTo(map);
        endMarker = L.marker([g2.lat, g2.lng], {icon:endIcon}).addTo(map);

        // Build the route request (single suggested route)
        const ghVehicle = VEHICLE_PROFILE[vehicle] || 'car';
        const u = new URL('https://graphhopper.com/api/1/route');
        const p = u.searchParams;
        p.set('point', `${g1.lat},${g1.lng}`);
        p.append('point', `${g2.lat},${g2.lng}`);
        p.set('vehicle', ghVehicle);
        p.set('points_encoded','false');
        p.set('instructions','true');
        p.set('key', DEFAULT_KEY);

        const res = await fetch(u.toString());
        const data = await res.json();
        if(!data.paths || !data.paths.length) throw new Error(data.message || 'No route found');

        const path = data.paths[0];

        const coords = path.points.coordinates.map(c=>[c[1],c[0]]);
        drawRoute(coords);

        // KPIs & instructions
        const km = path.distance / 1000;
        const durMs = path.time;
        setKPI({ km, durMs, vehicle });
        renderInstructions(path);

        $('status').innerText = 'Route generated successfully!';
      }catch(e){
        $('status').innerText = 'Error: ' + e.message;
        console.error(e);
      }
    });
  </script>
</body>
</html>
